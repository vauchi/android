# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-android
#
# Android app (Kotlin/Compose)
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing (Android)
#   - Dependency Scanning: Gradle dependency scanning
#   - Secret Detection: Prevent credential leaks
#   - Mobile App Security Testing (MAST)
#
# REMEDIATION PLAN (allow_failure jobs):
# The app requires native UniFFI bindings from vauchi-mobile. Current failures:
# - Missing types: MobileDeliveryStatus, MobileDeliveryRecord, MobileRetryEntry, etc.
# - File: app/src/main/kotlin/com/vauchi/ui/DeliveryStatusScreen.kt
#
# To fix, choose one approach:
# 1. Add a build step that compiles vauchi-mobile for Android targets first
#    - Requires Rust toolchain + Android NDK in CI
#    - Run: cargo ndk -t arm64-v8a -t armeabi-v7a build --release -p vauchi-mobile
# 2. Use pre-built bindings from vauchi/core CI artifacts
# 3. Publish vauchi-mobile to Maven and add as dependency
#
# Once native bindings are available in CI, remove `allow_failure: true`

# GitLab Ultimate Templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml


stages:
  - lint
  - build
  - test
  - security

variables:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"

  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "build/, .gradle/"
  DS_EXCLUDED_PATHS: "build/, .gradle/"
  SECRET_DETECTION_EXCLUDED_PATHS: "build/, .gradle/"

  # Enable Android-specific SAST analyzers
  SAST_ANALYZER_IMAGE_TAG: "5"

.gradle-cache: &gradle-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/

.android-job:
  image: cimg/android:2024.01
  <<: *gradle-cache

# ============================================================
# Lint Stage
# ============================================================

lint:
  extends: .android-job
  stage: lint
  script:
    - ./gradlew lint
  artifacts:
    reports:
      codequality: app/build/reports/lint-results.xml
    paths:
      - app/build/reports/lint-results-*.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings

lint:detekt:
  extends: .android-job
  stage: lint
  script:
    - ./gradlew detekt || echo "Detekt not configured"
  artifacts:
    reports:
      codequality: app/build/reports/detekt/detekt.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ============================================================
# Build Stage
# ============================================================

build:debug:
  extends: .android-job
  stage: build
  script:
    - ./gradlew assembleDebug
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings

build:release:
  extends: .android-job
  stage: build
  script:
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - app/build/outputs/apk/release/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  allow_failure: true  # Requires native bindings

# ============================================================
# Test Stage
# ============================================================

test:unit:
  extends: .android-job
  stage: test
  script:
    - ./gradlew test
  artifacts:
    reports:
      junit: app/build/test-results/**/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings

# ============================================================
# Security Stage
# ============================================================

# GitLab security templates configuration
# Override child analyzer jobs (not parent stubs) to add tags and rules

semgrep-sast:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Gemnasium for Gradle dependencies
gemnasium-dependency_scanning:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

secret_detection:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"


# Gradle dependency check
security:dependency-check:
  extends: .android-job
  stage: security
  script:
    - ./gradlew dependencyCheckAnalyze || echo "OWASP dependency check not configured"
  artifacts:
    paths:
      - app/build/reports/dependency-check-report.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "build.gradle*"
        - "app/build.gradle*"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
