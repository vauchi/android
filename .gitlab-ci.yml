# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-android
#
# Android app (Kotlin/Compose)
#
# Native bindings:
#   Consumed from vauchi-mobile-android via GitLab Maven registry.
#   The vauchi/core release pipeline builds UniFFI bindings, packages them,
#   and triggers vauchi-mobile-android to publish an AAR to Maven.
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Interruptible: Auto-cancel on new commits
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing (Android)
#   - Dependency Scanning: Gradle dependency scanning
#   - Secret Detection: Prevent credential leaks
#   - Mobile App Security Testing (MAST)

# GitLab Ultimate Templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml


stages:
  - lint
  - build
  - test
  - security

variables:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"

  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "build/, .gradle/"
  DS_EXCLUDED_PATHS: "build/, .gradle/"
  SECRET_DETECTION_EXCLUDED_PATHS: "build/, .gradle/"

  # Exclude gemnasium-maven analyzer â€” Gradle is covered by gemnasium.
  # The maven analyzer fails on test-only Compose dependencies that are
  # not fully resolvable outside Android SDK (ui-tooling, ui-test-manifest).
  DS_EXCLUDED_ANALYZERS: "gemnasium-maven"

  # Enable Android-specific SAST analyzers
  SAST_ANALYZER_IMAGE_TAG: "5"

# Interruptible default for auto-cancel
default:
  interruptible: true

.gradle-cache:
  cache: &gradle-cache
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/

.android-job:
  image: cimg/android:2024.01
  cache:
    <<: *gradle-cache

# Timeout templates
.timeout-quick:
  timeout: 10 minutes

.timeout-standard:
  timeout: 30 minutes

.timeout-long:
  timeout: 1 hour

# ============================================================
# Lint Stage (change-based)
# ============================================================

lint:
  extends: [.android-job, .timeout-standard]
  stage: lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/
    policy: pull  # Read-only for lint
  script:
    - ./gradlew lint
  artifacts:
    reports:
      codequality: app/build/reports/lint-results.xml
    paths:
      - app/build/reports/lint-results-*.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - "**/*.xml"
        - "build.gradle*"
        - "app/build.gradle*"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Pre-existing: MobileUpdateType/kotlinx.serialization not yet available

lint:detekt:
  extends: [.android-job, .timeout-quick]
  stage: lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/
    policy: pull  # Read-only for lint
  script:
    - ./gradlew detekt || echo "Detekt not configured"
  artifacts:
    reports:
      codequality: app/build/reports/detekt/detekt.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.kt"
        - "detekt.yml"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ============================================================
# Build Stage (change-based)
# ============================================================

build:debug:
  extends: [.android-job, .timeout-standard]
  stage: build
  script:
    - ./gradlew assembleDebug
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - "**/*.xml"
        - "build.gradle*"
        - "app/build.gradle*"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Pre-existing: MobileUpdateType/kotlinx.serialization not yet available

build:release:
  extends: [.android-job, .timeout-long]
  stage: build
  script:
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - app/build/outputs/apk/release/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# ============================================================
# Test Stage (change-based)
# ============================================================

test:unit:
  extends: [.android-job, .timeout-standard]
  stage: test
  script:
    - ./gradlew test
  artifacts:
    reports:
      junit: app/build/test-results/**/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - "build.gradle*"
        - "app/build.gradle*"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Pre-existing: MobileUpdateType/kotlinx.serialization not yet available

# ============================================================
# Security Stage (change-based)
# ============================================================

# GitLab security templates configuration
# Override child analyzer jobs (not parent stubs) to add tags and rules

semgrep-sast:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Gemnasium for Gradle dependencies
gemnasium-dependency_scanning:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "build.gradle*"
        - "app/build.gradle*"
        - "gradle.properties"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

secret_detection:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"


# Gradle dependency check (runs on dependency changes)
security:dependency-check:
  extends: [.android-job, .timeout-standard]
  stage: security
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/
    policy: pull  # Read-only
  script:
    - ./gradlew dependencyCheckAnalyze || echo "OWASP dependency check not configured"
  artifacts:
    paths:
      - app/build/reports/dependency-check-report.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "build.gradle*"
        - "app/build.gradle*"
        - ".gitlab-ci.yml"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
