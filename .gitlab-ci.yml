# GitLab CI for vauchi-android
#
# Android app (Kotlin/Compose)
#
# REMEDIATION PLAN (allow_failure jobs):
# The app requires native UniFFI bindings from vauchi-mobile. Current failures:
# - Missing types: MobileDeliveryStatus, MobileDeliveryRecord, MobileRetryEntry, etc.
# - File: app/src/main/kotlin/com/vauchi/ui/DeliveryStatusScreen.kt
#
# To fix, choose one approach:
# 1. Add a build step that compiles vauchi-mobile for Android targets first
#    - Requires Rust toolchain + Android NDK in CI
#    - Run: cargo ndk -t arm64-v8a -t armeabi-v7a build --release -p vauchi-mobile
# 2. Use pre-built bindings from vauchi/core CI artifacts
# 3. Publish vauchi-mobile to Maven and add as dependency
#
# Once native bindings are available in CI, remove `allow_failure: true`

stages:
  - lint
  - build
  - test

variables:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"

.gradle-cache: &gradle-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/

lint:
  stage: lint
  image: cimg/android:2024.01
  <<: *gradle-cache
  script:
    - ./gradlew lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings

build:debug:
  stage: build
  image: cimg/android:2024.01
  <<: *gradle-cache
  script:
    - ./gradlew assembleDebug
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings

test:unit:
  stage: test
  image: cimg/android:2024.01
  <<: *gradle-cache
  script:
    - ./gradlew test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true  # Requires native bindings
