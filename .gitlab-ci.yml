# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-android
#
# Android app (Kotlin/Compose)
#
# Native bindings:
#   Consumed from vauchi-mobile-android via GitLab Maven registry.
#   The vauchi/core release pipeline builds UniFFI bindings, packages them,
#   and triggers vauchi-mobile-android to publish an AAR to Maven.
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Interruptible: Auto-cancel on new commits
#
# Pipeline strategy:
#   - MR: Full validation (lint, build, test, security)
#   - Tag: Release build
#   - Scheduled: Security scans
#   Main branch is protected and merge-only. All validation happens
#   during the MR pipeline; post-merge pipelines are unnecessary.
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing (Android)
#   - Dependency Scanning: Gradle dependency scanning (gemnasium)
#   - Secret Detection: Prevent credential leaks

# GitLab Ultimate Templates + shared timeout definitions
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/timeouts.yml'
      - '/ci-templates/reuse.yml'

stages:
  - update
  - lint
  - build
  - test
  - security

variables:
  ANDROID_COMPILE_SDK: "35"
  ANDROID_BUILD_TOOLS: "35.0.0"

  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "build/, .gradle/"
  DS_EXCLUDED_PATHS: "build/, .gradle/"
  SECRET_DETECTION_EXCLUDED_PATHS: "build/, .gradle/"

  # Exclude gemnasium-maven analyzer — Gradle is covered by gemnasium.
  # The maven analyzer fails on test-only Compose dependencies that are
  # not fully resolvable outside Android SDK (ui-tooling, ui-test-manifest).
  DS_EXCLUDED_ANALYZERS: "gemnasium-maven"

  # Enable Android-specific SAST analyzers
  SAST_ANALYZER_IMAGE_TAG: "5"

# Interruptible default for auto-cancel
default:
  interruptible: true

workflow:
  auto_cancel:
    on_new_commit: interruptible

.gradle-cache:
  cache: &gradle-cache
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/

.android-job:
  image: cimg/android:2024.01
  cache:
    <<: *gradle-cache

# Timeout templates provided by vauchi/scripts ci-templates/timeouts.yml

# ============================================================
# Update Stage (triggered by upstream distribution repo)
# ============================================================

# Automatically bump vauchi-mobile dependency and create MR
update:bindings-version:
  stage: update
  image: alpine:latest
  rules:
    - if: ($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "pipeline" || $CI_PIPELINE_SOURCE == "api") && $BINDINGS_VERSION
  script:
    - apk add --no-cache git curl jq sed
    - |
      echo "Bumping vauchi-mobile to $BINDINGS_VERSION"

      BRANCH="chore/bump-vauchi-mobile-${BINDINGS_VERSION}"
      BUILD_FILE="app/build.gradle.kts"

      # Configure git
      git config user.email "ci@vauchi.com"
      git config user.name "Vauchi CI"
      git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"

      # Check if branch already exists on remote
      if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
        echo "Branch $BRANCH already exists — version bump already in progress"
        exit 0
      fi

      # Create branch and update version
      git checkout -b "$BRANCH"
      sed -i "s/implementation(\"com.vauchi:vauchi-mobile:[^\"]*\")/implementation(\"com.vauchi:vauchi-mobile:${BINDINGS_VERSION}\")/" "$BUILD_FILE"

      # Verify the change was made
      if ! grep -q "com.vauchi:vauchi-mobile:${BINDINGS_VERSION}" "$BUILD_FILE"; then
        echo "ERROR: Version replacement failed"
        exit 1
      fi

      git add "$BUILD_FILE"
      git commit -m "chore: Bump vauchi-mobile to $BINDINGS_VERSION"
      git push -u origin "$BRANCH"

      # Create MR via GitLab API
      MR_RESPONSE=$(curl -s --request POST \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"source_branch\": \"$BRANCH\",
          \"target_branch\": \"main\",
          \"title\": \"chore: Bump vauchi-mobile to $BINDINGS_VERSION\",
          \"description\": \"Automated version bump triggered by vauchi-mobile-android release.\\n\\nUpdates \`com.vauchi:vauchi-mobile\` from current version to \`$BINDINGS_VERSION\`.\\n\\n---\\n_This MR was created automatically by CI._\",
          \"remove_source_branch\": true
        }" \
        "${CI_SERVER_URL}/api/v4/projects/${CI_PROJECT_ID}/merge_requests")

      MR_URL=$(echo "$MR_RESPONSE" | jq -r '.web_url // empty')
      if [ -n "$MR_URL" ]; then
        echo "Created MR: $MR_URL"
      else
        echo "MR creation response: $MR_RESPONSE"
        # MR may already exist if branch was force-pushed
        echo "WARNING: Could not create MR (may already exist)"
      fi

# ============================================================
# Lint Stage (MR only, change-based)
# ============================================================

lint:
  extends: [.android-job, .timeout-standard]
  stage: lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gradle
    paths:
      - .gradle/
      - build/
      - app/build/
    policy: pull  # Read-only for lint
  script:
    - ./gradlew lint
  artifacts:
    reports:
      codequality: app/build/reports/lint-results.xml
    paths:
      - app/build/reports/lint-results-*.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.kt"
          - "**/*.java"
          - "**/*.xml"
          - "build.gradle*"
          - "app/build.gradle*"
          - ".gitlab-ci.yml"

# ============================================================
# Build Stage (MR: debug, Tag: release)
# ============================================================

build:debug:
  extends: [.android-job, .timeout-standard]
  stage: build
  script:
    - ./gradlew assembleDebug
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.kt"
          - "**/*.java"
          - "**/*.xml"
          - "build.gradle*"
          - "app/build.gradle*"
          - ".gitlab-ci.yml"

build:release:
  extends: [.android-job, .timeout-long]
  stage: build
  script:
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - app/build/outputs/apk/release/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# ============================================================
# Test Stage (MR only, change-based)
# ============================================================

test:unit:
  extends: [.android-job, .timeout-standard]
  stage: test
  script:
    - ./gradlew test
  artifacts:
    reports:
      junit: app/build/test-results/**/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.kt"
          - "**/*.java"
          - "build.gradle*"
          - "app/build.gradle*"
          - ".gitlab-ci.yml"

test:screenshots:
  extends: [.android-job, .timeout-standard]
  stage: test
  allow_failure: true
  script:
    - ./gradlew validateDebugScreenshotTest
  artifacts:
    when: on_failure
    paths:
      - app/build/reports/screenshotTest/
      - app/src/screenshotTestDebug/reference/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.kt"
          - "**/*.java"
          - "build.gradle*"
          - "app/build.gradle*"
          - "gradle.properties"
          - ".gitlab-ci.yml"

# ============================================================
# Security Stage (MR + scheduled)
# ============================================================

# GitLab security templates configuration
# Override child analyzer jobs (not parent stubs) to add tags and rules

semgrep-sast:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.kt"
          - "**/*.java"
          - ".gitlab-ci.yml"
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Gemnasium for Gradle dependencies
gemnasium-dependency_scanning:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "build.gradle*"
          - "app/build.gradle*"
          - "gradle.properties"
          - ".gitlab-ci.yml"
    - if: $CI_PIPELINE_SOURCE == "schedule"

secret_detection:
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
